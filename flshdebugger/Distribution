<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="1">
    <title>Adobe Pepper Flash Player</title>
    <!-- If we want to customize GUI installer later:
	<welcome file="Welcome.rtf"/>
    <readme file="ReadMe.rtf"/>
    <background file="background.tiff" scaling="proportional" alignment="bottomleft"/> 
    -->
    <pkg-ref id="com.adobe.pkg.PepperFlashPlayer">
        <bundle-version>
            <bundle CFBundleShortVersionString="0.1" CFBundleVersion="0.1" SourceVersion="270000" BuildVersion="1" id="com.adobe.flashplayerpreferences" path="Library/PreferencePanes/Flash Player.prefPane"/>
            <bundle CFBundleShortVersionString="32.0.0.192" CFBundleVersion="32.0.0.192" id="com.adobe.flashplayer.installmanager" path="Applications/Utilities/Adobe Flash Player Install Manager.app"/>
        </bundle-version>
    </pkg-ref>
    <options customize="never" require-scripts="false"/>
    <choices-outline>
        <line choice="default">
            <line choice="com.adobe.pkg.PepperFlashPlayer"/>
        </line>
    </choices-outline>
    <choice id="default"/>
    <choice id="com.adobe.pkg.PepperFlashPlayer" visible="false">
        <pkg-ref id="com.adobe.pkg.PepperFlashPlayer"/>
    </choice>
    <volume-check script="VolumeCheck()"/>
    <script><![CDATA[
    function VolumeCheck()
    {
    	system.log("Flash Player Install: Performing volume check for " + my.target.mountpoint);
    	
    	// Check for an OSX install on Volume
    	var osVersionPListPath = my.target.mountpoint + "/System/Library/CoreServices/SystemVersion.plist";
        var osVersionPList = system.files.plistAtPath(osVersionPListPath);
        if (osVersionPList == null) {
        	system.log("Flash Player Install: Error: Non-OS Volume detected.");
        	my.result.message = system.localizedStringWithFormat("SystemDoesNotMeetMinimumRequirements", "10.6");
        	my.result.type = 'Fatal';
            return false;
        }
        
        // Check if OSX version is at least minimum supported
        if (system.compareVersions(osVersionPList.ProductVersion, "10.6") == -1) {
        	system.log("Flash Player Install: Error: OSX " + my.target.systemVersion.ProductVersion + " is not supported. OSX 10.6+ is required.");
        	my.result.message = system.localizedStringWithFormat("SystemDoesNotMeetMinimumRequirements", "10.6");
        	my.result.type = 'Fatal';
            return false;
        }
        
        // Get the path to .plist of installed plugin, if present.
        var plistPath = my.target.mountpoint + "/Library/Internet Plug-Ins/PepperFlashPlayer/PepperFlashPlayer.plugin/Contents/Info.plist";
        var plist = system.files.plistAtPath(plistPath);

        // Prevent install of 'r' over 'd' and vice versa
        var currentBuildChannel = "r0"
        if (plist && plist.CFBundleGetInfoString) {
            if (plist.CFBundleGetInfoString.indexOf(currentBuildChannel) == -1) {
                // The build on the system doesn't match the channel of the build we are installing, so error out           
                system.log("Flash Player Install: Error: You must run the Flash Player uninstaller before installing this version of Flash Player. Please visit the Adobe Labs web page to download the uninstaller. http://labs.adobe.com/downloads/flashplayer.html");
                my.result.message = system.localizedString("NeedToUninstallFirst") + "\nhttp://labs.adobe.com/downloads/flashplayer.html";
                my.result.type = 'Fatal';
                return false;
            }
        }
        
        // Check for downgrade attempt        
        if (plist && plist.CFBundleShortVersionString && (system.compareVersions("32.0.0.192", plist.CFBundleShortVersionString) == -1)) {
            system.log("Flash Player Install: Error: A newer version of the software is already installed on this volume.");
            system.log("Version to be installed: 32.0.0.192");
            system.log("Version on volume: " + plist.CFBundleShortVersionString);
        	my.result.message = system.localizedString("NewerFlashPlayerAlreadyInstalled") + "\n" + system.localizedString("InstalledVersionTitle") + " " + plist.CFBundleShortVersionString + "\n" + system.localizedString("ThisVersionTitle") + " 32.0.0.192";
        	my.result.type = 'Fatal';
            return false;
        }

        system.log("Flash Player Install: Volume check passed.");
        return true;
    }
    ]]></script>
    <pkg-ref id="com.adobe.pkg.PepperFlashPlayer" version="32.0.0.192" onConclusion="none" installKBytes="21885">#AdobeFlashPlayerComponent.pkg</pkg-ref>
</installer-gui-script>